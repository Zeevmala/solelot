<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Map Integration Tests - Battery Recycling Map</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; padding: 20px; background: #f5f5f5; direction: ltr; }
        h1 { margin-bottom: 5px; }
        h2 { margin: 20px 0 10px; color: #555; font-size: 16px; }
        .test { padding: 8px 12px; margin: 4px 0; border-radius: 6px; font-size: 14px; }
        .pass { background: #e8f5e9; color: #2e7d32; }
        .fail { background: #ffebee; color: #c62828; }
        .summary { margin-top: 20px; padding: 12px; border-radius: 8px; font-weight: bold; font-size: 16px; }
        .summary.all-pass { background: #c8e6c9; color: #1b5e20; }
        .summary.has-fail { background: #ef9a9a; color: #b71c1c; }
        .note { color: #888; font-size: 13px; margin-bottom: 15px; }
    </style>
</head>
<body>
    <h1>Map Integration Tests</h1>
    <p class="note">Tests locations.json data integrity and HTML template output</p>
    <div id="results"></div>
    <div id="summary"></div>

    <script>
    let passed = 0, failed = 0;
    const results = document.getElementById('results');

    function assert(condition, name) {
        const div = document.createElement('div');
        div.className = 'test ' + (condition ? 'pass' : 'fail');
        div.textContent = (condition ? '\u2705' : '\u274C') + ' ' + name;
        results.appendChild(div);
        condition ? passed++ : failed++;
    }

    function section(title) {
        const h2 = document.createElement('h2');
        h2.textContent = title;
        results.appendChild(h2);
    }

    // === Import pure functions ===
    function escapeHtml(str) {
        if (!str) return '';
        return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;');
    }

    const REPORT_FORM_URL = 'https://docs.google.com/forms/d/e/1FAIpQLSey-yMW6dMKCiq0mPqdWdNTa3ccg0xQ6zn-Ca_3f6jiOMCbng/viewform';
    function getReportUrl(location) {
        const params = new URLSearchParams({
            'entry.1466478113': location.name,
            'entry.1234054889': location.address,
            'entry.1388870063': location.city,
            'hl': 'he'
        });
        return REPORT_FORM_URL + '?' + params.toString();
    }

    // Popup template (matches app.js createPopupContent)
    function createPopupContent(location) {
        let content = '<div class="popup-header"><h3><span class="popup-icon">ICON</span>' + escapeHtml(location.name) + '</h3></div>';
        content += '<div class="popup-row"><span>' + escapeHtml(location.address) + '</span></div>';

        if (location.hours && location.hours !== '\u05D1\u05D3\u05D5\u05E7 \u05D1\u05D0\u05EA\u05E8') {
            content += '<div class="popup-row"><span class="icon">\uD83D\uDD50</span><span>' + escapeHtml(location.hours) + '</span></div>';
        }
        if (location.description) {
            content += '<div class="popup-row"><span class="icon">\u2139\uFE0F</span><span>' + escapeHtml(location.description) + '</span></div>';
        }

        const googleMapsUrl = 'https://www.google.com/maps/dir/?api=1&destination=' + location.lat + ',' + location.lng;
        const wazeUrl = 'https://waze.com/ul?ll=' + location.lat + ',' + location.lng + '&navigate=yes';
        const reportUrl = getReportUrl(location);

        content += '<div class="nav-links"><a href="' + googleMapsUrl + '" target="_blank" class="nav-btn google">Google Maps</a>';
        content += '<a href="' + wazeUrl + '" target="_blank" class="nav-btn waze">Waze</a></div>';
        content += '<a href="' + reportUrl + '" target="_blank" class="report-link">\u05D3\u05D5\u05D5\u05D7 \u05E2\u05DC \u05D1\u05E2\u05D9\u05D4</a>';

        return content;
    }

    // Sidebar template (matches app.js createSidebarContent)
    function createSidebarContent(location) {
        let html = '<div class="sidebar-header"><div class="sidebar-title"><h2>' + escapeHtml(location.name) + '</h2></div></div>';
        html += '<div class="sidebar-info"><div class="info-row"><span class="info-text">' + escapeHtml(location.address) + '</span></div>';
        html += '<div class="info-row"><span class="info-icon">\uD83C\uDFD9\uFE0F</span><span class="info-text">' + escapeHtml(location.city) + '</span></div>';

        if (location.hours && location.hours !== '\u05D1\u05D3\u05D5\u05E7 \u05D1\u05D0\u05EA\u05E8') {
            html += '<div class="info-row"><span class="info-icon">\uD83D\uDD50</span><span class="info-text">' + escapeHtml(location.hours) + '</span></div>';
        }
        html += '</div>';

        const googleMapsUrl = 'https://www.google.com/maps/dir/?api=1&destination=' + location.lat + ',' + location.lng;
        const wazeUrl = 'https://waze.com/ul?ll=' + location.lat + ',' + location.lng + '&navigate=yes';
        html += '<div class="sidebar-nav"><a href="' + googleMapsUrl + '" class="sidebar-nav-btn google">\u05E0\u05D5\u05D5\u05D8 \u05D1-Google</a>';
        html += '<a href="' + wazeUrl + '" class="sidebar-nav-btn waze">\u05E0\u05D5\u05D5\u05D8 \u05D1-Waze</a></div>';

        return html;
    }

    // === Load and test locations.json ===
    fetch('locations.json')
        .then(r => r.json())
        .then(data => {
            const locations = data.locations;

            // --- Data integrity ---
            section('Data Integrity');
            assert(Array.isArray(locations), 'locations is an array');
            assert(locations.length > 0, 'locations has entries (' + locations.length + ')');

            let missingFields = 0;
            let invalidCoords = 0;
            let invalidTypes = 0;
            let emptyNames = 0;
            let emptyCities = 0;
            let badHoursCount = 0;

            locations.forEach((loc, i) => {
                if (!loc.name || !loc.address || !loc.city || !loc.type || loc.lat === undefined || loc.lng === undefined) missingFields++;
                if (typeof loc.lat !== 'number' || typeof loc.lng !== 'number') invalidCoords++;
                if (loc.lat < 29 || loc.lat > 34 || loc.lng < 34 || loc.lng > 36) invalidCoords++;
                if (loc.type !== 'store' && loc.type !== 'facility') invalidTypes++;
                if (!loc.name || loc.name.trim() === '') emptyNames++;
                if (!loc.city || loc.city.trim() === '') emptyCities++;
                if (loc.hours === '\u05D1\u05D3\u05D5\u05E7 \u05D1\u05D0\u05EA\u05E8') badHoursCount++;
            });

            assert(missingFields === 0, 'All locations have required fields (name, address, city, type, lat, lng)' + (missingFields > 0 ? ' \u2014 ' + missingFields + ' missing' : ''));
            assert(invalidCoords === 0, 'All coordinates within Israel bounds (29-34N, 34-36E)' + (invalidCoords > 0 ? ' \u2014 ' + invalidCoords + ' invalid' : ''));
            assert(invalidTypes === 0, 'All types are "store" or "facility"' + (invalidTypes > 0 ? ' \u2014 ' + invalidTypes + ' invalid' : ''));
            assert(emptyNames === 0, 'No empty location names');
            assert(emptyCities === 0, 'No empty city names');

            // Info only (not a fail)
            const infoDiv = document.createElement('div');
            infoDiv.className = 'test pass';
            infoDiv.textContent = '\u2139\uFE0F ' + badHoursCount + ' locations have "\u05D1\u05D3\u05D5\u05E7 \u05D1\u05D0\u05EA\u05E8" hours (filtered out in UI)';
            results.appendChild(infoDiv);

            // --- Duplicate check ---
            section('Duplicate Detection');
            const coordSet = new Set();
            let dupeCoords = 0;
            locations.forEach(loc => {
                const key = loc.lat + ',' + loc.lng;
                if (coordSet.has(key)) dupeCoords++;
                coordSet.add(key);
            });
            // Some duplicate coords are expected (multiple stores in same building)
            const dupeInfo = document.createElement('div');
            dupeInfo.className = 'test pass';
            dupeInfo.textContent = '\u2139\uFE0F ' + dupeCoords + ' locations share coordinates with another (e.g. same building)';
            results.appendChild(dupeInfo);

            // --- Popup template tests ---
            section('Popup Template');
            const testLoc = { id: 1, name: '\u05E1\u05D5\u05E4\u05E8 \u05E4\u05D0\u05E8\u05DD', address: '\u05E8\u05D7\u05D5\u05D1 \u05D4\u05E8\u05E6\u05DC 10', city: '\u05EA\u05DC \u05D0\u05D1\u05D9\u05D1', lat: 32.08, lng: 34.78, type: 'store', hours: '08:00-22:00' };
            const popup = createPopupContent(testLoc);

            assert(!popup.includes('\uD83D\uDCCD'), 'Popup: no pin emoji in address row');
            assert(popup.includes('Google Maps'), 'Popup: Google Maps button text (no emoji)');
            assert(popup.includes('Waze'), 'Popup: Waze button text (no emoji)');
            assert(popup.includes('nav-btn google'), 'Popup: Google button has correct class');
            assert(popup.includes('nav-btn waze'), 'Popup: Waze button has correct class');
            assert(popup.includes('\u05D3\u05D5\u05D5\u05D7 \u05E2\u05DC \u05D1\u05E2\u05D9\u05D4'), 'Popup: report link present');
            assert(popup.includes('08:00-22:00'), 'Popup: real hours shown');

            const testLocBadHours = { id: 2, name: '\u05EA\u05D7\u05E0\u05D4', address: '\u05DB\u05EA\u05D5\u05D1\u05EA', city: '\u05E2\u05D9\u05E8', lat: 32.0, lng: 34.8, type: 'store', hours: '\u05D1\u05D3\u05D5\u05E7 \u05D1\u05D0\u05EA\u05E8' };
            const popupBad = createPopupContent(testLocBadHours);
            assert(!popupBad.includes('\u05D1\u05D3\u05D5\u05E7 \u05D1\u05D0\u05EA\u05E8'), 'Popup: "\u05D1\u05D3\u05D5\u05E7 \u05D1\u05D0\u05EA\u05E8" filtered out');

            const testLocNoHours = { id: 3, name: '\u05D7\u05E0\u05D5\u05EA', address: '\u05DB\u05EA\u05D5\u05D1\u05EA', city: '\u05E2\u05D9\u05E8', lat: 32.0, lng: 34.8, type: 'store' };
            const popupNoHours = createPopupContent(testLocNoHours);
            assert(!popupNoHours.includes('\uD83D\uDD50'), 'Popup: no clock icon when no hours');

            // --- Sidebar template tests ---
            section('Sidebar Template');
            const sidebar = createSidebarContent(testLoc);

            assert(!sidebar.includes('sidebar-icon'), 'Sidebar: no pin icon div');
            assert(sidebar.includes('\u05E0\u05D5\u05D5\u05D8 \u05D1-Google'), 'Sidebar: Google nav text (no emoji)');
            assert(sidebar.includes('\u05E0\u05D5\u05D5\u05D8 \u05D1-Waze'), 'Sidebar: Waze nav text (no emoji)');
            assert(sidebar.includes('sidebar-nav-btn google'), 'Sidebar: Google button has correct class');
            assert(sidebar.includes('sidebar-nav-btn waze'), 'Sidebar: Waze button has correct class');
            assert(!sidebar.includes('\uD83D\uDCCD'), 'Sidebar: no pin emoji in address');

            const sidebarBad = createSidebarContent(testLocBadHours);
            assert(!sidebarBad.includes('\u05D1\u05D3\u05D5\u05E7 \u05D1\u05D0\u05EA\u05E8'), 'Sidebar: "\u05D1\u05D3\u05D5\u05E7 \u05D1\u05D0\u05EA\u05E8" filtered out');

            // --- XSS protection ---
            section('XSS Protection');
            const xssLoc = { id: 99, name: '<scr' + 'ipt>alert(1)<\/scr' + 'ipt>', address: '"><img onerror=alert(1)>', city: 'test', lat: 32.0, lng: 34.8, type: 'store' };
            const xssPopup = createPopupContent(xssLoc);
            assert(!xssPopup.includes('<scr' + 'ipt>'), 'XSS: script tag escaped in popup');
            assert(!xssPopup.includes('<img'), 'XSS: img tag escaped in popup');
            const xssSidebar = createSidebarContent(xssLoc);
            assert(!xssSidebar.includes('<scr' + 'ipt>'), 'XSS: script tag escaped in sidebar');

            // --- Navigation URLs ---
            section('Navigation URLs');
            assert(popup.includes('google.com/maps/dir'), 'Nav: Google Maps URL present');
            assert(popup.includes('waze.com/ul'), 'Nav: Waze URL present');
            assert(popup.includes('destination=32.08,34.78'), 'Nav: correct coordinates in URL');

            // --- Summary ---
            const summary = document.getElementById('summary');
            summary.className = 'summary ' + (failed === 0 ? 'all-pass' : 'has-fail');
            summary.textContent = passed + ' passed, ' + failed + ' failed out of ' + (passed + failed) + ' tests';
        })
        .catch(err => {
            const div = document.createElement('div');
            div.className = 'test fail';
            div.textContent = '\u274C Failed to load locations.json: ' + err.message;
            results.appendChild(div);

            const summary = document.getElementById('summary');
            summary.className = 'summary has-fail';
            summary.textContent = 'Tests could not run - locations.json failed to load';
        });
    </script>
</body>
</html>
